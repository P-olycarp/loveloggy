<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Chat ‚Ä¢ LoveLoggy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'DM Sans', 'sans-serif']
                    },
                    colors: {
                        sand: {
                            50: '#F7F5F2',
                            100: '#EBE7E0',
                            200: '#EBE7E0',
                            300: '#A69C8E',
                            500: '#8B7E74',
                            600: '#5D5752'
                        },
                        clay: '#9E8C78',
                        ios: {
                            blue: '#007AFF',
                            bg: '#EBE7E0',
                            card: '#FFFFFF',
                            separator: '#C6C6C8',
                            text: '#000000',
                            secondary: '#8E8E93',
                            red: '#FF3B30',
                            green: '#34C759'
                        }
                    }
                }
            }
        }
    </script>
    <script src="src/auth.js"></script>
    <script src="src/settings.js"></script>
    <script src="src/encryption.js"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .ios-blur {
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
        }
        
        /* Settings Panel Slide Animation */
        .settings-panel {
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .settings-panel.open {
            transform: translateX(0);
        }
        
        /* Overlay */
        .settings-overlay {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        
        /* Theme Variables */
        :root {
            --bg-primary: #EBE7E0;
            --bg-card: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --accent-color: #007AFF;
            --accent-secondary: #9E8C78;
        }
        
        /* Dark Theme */
        body.dark-theme {
            --bg-primary: #1C1C1E;
            --bg-card: #2C2C2E;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --accent-color: #0A84FF;
            --accent-secondary: #BFA98E;
        }
        
        /* Rose Theme */
        body.rose-theme {
            --bg-primary: #FFF0F3;
            --bg-card: #FFFFFF;
            --text-primary: #4A1A2C;
            --text-secondary: #9E6B7D;
            --accent-color: #E91E63;
            --accent-secondary: #F48FB1;
        }
        
        /* Ocean Theme */
        body.ocean-theme {
            --bg-primary: #E8F4F8;
            --bg-card: #FFFFFF;
            --text-primary: #1A3A4A;
            --text-secondary: #5A8A9E;
            --accent-color: #0288D1;
            --accent-secondary: #4FC3F7;
        }
        
        /* Lavender Theme */
        body.lavender-theme {
            --bg-primary: #F3E8FF;
            --bg-card: #FFFFFF;
            --text-primary: #3D1A5C;
            --text-secondary: #8B5A9E;
            --accent-color: #9C27B0;
            --accent-secondary: #CE93D8;
        }
        
        /* Mint Theme */
        body.mint-theme {
            --bg-primary: #E8F5E9;
            --bg-card: #FFFFFF;
            --text-primary: #1B3A1F;
            --text-secondary: #5A8A5E;
            --accent-color: #4CAF50;
            --accent-secondary: #81C784;
        }
        
        /* Apply theme variables */
        body.themed {
            background-color: var(--bg-primary) !important;
        }
        body.themed .themed-bg {
            background-color: var(--bg-primary) !important;
        }
        body.themed .themed-card {
            background-color: var(--bg-card) !important;
        }
        body.themed .themed-text {
            color: var(--text-primary) !important;
        }
        body.themed .themed-text-secondary {
            color: var(--text-secondary) !important;
        }
        body.themed .themed-accent {
            color: var(--accent-color) !important;
        }
        body.themed .themed-accent-bg {
            background-color: var(--accent-color) !important;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 51px;
            height: 31px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #E5E5EA;
            transition: 0.4s;
            border-radius: 31px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .toggle-slider {
            background-color: #34C759;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Theme Preview Circles */
        .theme-option {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .theme-option:hover {
            transform: scale(1.1);
        }
        .theme-option.selected {
            box-shadow: 0 0 0 3px var(--accent-color, #007AFF);
        }
        
        /* Responsive Navigation */
        @media (max-width: 380px) {
            .nav-item span {
                font-size: 9px !important;
            }
            .nav-item i {
                font-size: 18px !important;
            }
        }
    </style>
</head>
<body class="bg-ios-bg font-sans">
    <div class="max-w-md mx-auto bg-ios-bg min-h-screen relative flex flex-col">
        <!-- Header -->
        <div class="px-4 pt-6 pb-4 bg-ios-bg/90 ios-blur sticky top-0 z-10 border-b border-ios-separator/30">
            <div class="flex items-center gap-3">
                <button onclick="window.location.href='space.html'" class="text-ios-blue hover:text-ios-blue/80">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div class="flex items-center gap-3 flex-1">
                    <div class="flex -space-x-2">
                        <div id="avatarA" class="w-10 h-10 rounded-full border-2 border-ios-card overflow-hidden bg-ios-separator"></div>
                        <div id="avatarB" class="w-10 h-10 rounded-full border-2 border-ios-card overflow-hidden bg-ios-separator z-10"></div>
                    </div>
                    <div>
                        <h1 id="chatTitle" class="text-sm font-bold text-ios-text">Our Chat</h1>
                        <p class="text-[10px] text-ios-secondary flex items-center gap-1">
                            <i class="fas fa-lock text-ios-green"></i>
                            <span>End-to-end encrypted</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messagesArea" class="flex-1 overflow-y-auto no-scrollbar px-4 py-4 space-y-3">
            <!-- Messages will be injected here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex-1 items-center justify-center p-8">
            <div class="text-center">
                <div class="w-20 h-20 bg-sand-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-comments text-clay text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-sand-600 mb-2">Start Your Conversation</h3>
                <p class="text-ios-secondary text-sm mb-2">Your private, encrypted chat space</p>
                <p class="text-ios-secondary/70 text-xs">Messages are end-to-end encrypted üîí</p>
            </div>
        </div>

        <!-- Message Input -->
        <div class="sticky bottom-16 bg-ios-card/90 ios-blur border-t border-ios-separator/30 p-4">
            <div class="flex items-center gap-2">
                <input id="messageInput" type="text" placeholder="Type a message..." 
                    class="flex-1 bg-ios-bg rounded-full px-4 py-3 text-sm outline-none border border-ios-separator/30 focus:border-ios-blue text-ios-text">
                <button id="sendBtn" class="bg-ios-blue text-white w-12 h-12 rounded-full flex items-center justify-center shadow-md hover:shadow-lg transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 ios-blur border-t border-ios-separator/30 px-2 sm:px-6 py-2 flex justify-around items-center z-40 themed-card">
            <button onclick="window.location.href='space.html'" class="nav-item flex flex-col items-center gap-1 py-1 px-1 sm:px-2">
                <i class="fas fa-home text-ios-secondary text-lg sm:text-xl themed-text-secondary"></i>
                <span class="text-[9px] sm:text-[10px] text-ios-secondary themed-text-secondary">Home</span>
            </button>
            <button onclick="window.location.href='calendar.html'" class="nav-item flex flex-col items-center gap-1 py-1 px-1 sm:px-2">
                <i class="fas fa-calendar text-ios-secondary text-lg sm:text-xl themed-text-secondary"></i>
                <span class="text-[9px] sm:text-[10px] text-ios-secondary themed-text-secondary">Calendar</span>
            </button>
            <button onclick="window.location.href='journey.html'" class="nav-item flex flex-col items-center gap-1 py-1 px-1 sm:px-2">
                <i class="fas fa-heart text-ios-secondary text-lg sm:text-xl themed-text-secondary"></i>
                <span class="text-[9px] sm:text-[10px] text-ios-secondary themed-text-secondary">Journey</span>
            </button>
            <button onclick="window.location.href='chat.html'" class="nav-item flex flex-col items-center gap-1 py-1 px-1 sm:px-2">
                <i class="fas fa-comments text-ios-blue text-lg sm:text-xl themed-accent"></i>
                <span class="text-[9px] sm:text-[10px] text-ios-blue font-semibold themed-accent">Chat</span>
            </button>
            <button onclick="window.location.href='profile.html'" class="nav-item flex flex-col items-center gap-1 py-1 px-1 sm:px-2">
                <i class="fas fa-user text-ios-secondary text-lg sm:text-xl themed-text-secondary"></i>
                <span class="text-[9px] sm:text-[10px] text-ios-secondary themed-text-secondary">Profile</span>
            </button>
            <button onclick="openSettings()" class="nav-item flex flex-col items-center gap-1 py-1 px-1 sm:px-2">
                <i class="fas fa-bars text-ios-secondary text-lg sm:text-xl themed-text-secondary"></i>
                <span class="text-[9px] sm:text-[10px] text-ios-secondary themed-text-secondary">More</span>
            </button>
        </div>

        <!-- Settings Overlay -->
        <div id="settingsOverlay" class="settings-overlay fixed inset-0 bg-black/40 z-50" onclick="closeSettings()"></div>

        <!-- Settings Panel -->
        <div id="settingsPanel" class="settings-panel fixed top-0 right-0 bottom-0 w-80 max-w-[85vw] bg-ios-card z-50 shadow-2xl overflow-y-auto themed-card">
            <!-- Settings Header -->
            <div class="sticky top-0 bg-ios-card/95 ios-blur border-b border-ios-separator/30 px-4 py-4 themed-card">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold text-ios-text themed-text">Settings</h2>
                    <button onclick="closeSettings()" class="w-8 h-8 rounded-full bg-ios-separator/30 flex items-center justify-center">
                        <i class="fas fa-times text-ios-secondary"></i>
                    </button>
                </div>
            </div>

            <!-- Settings Content -->
            <div class="p-4 space-y-6">
                <!-- Theme Section -->
                <div class="bg-ios-bg rounded-2xl p-4 themed-bg">
                    <h3 class="text-sm font-semibold text-ios-text mb-3 themed-text">
                        <i class="fas fa-palette mr-2 text-ios-blue themed-accent"></i>App Theme
                    </h3>
                    <div class="grid grid-cols-6 gap-3 mb-4">
                        <button onclick="setTheme('default')" class="theme-option w-10 h-10 rounded-full bg-gradient-to-br from-[#EBE7E0] to-[#D4CFC6] border-2 border-white shadow-md" title="Sand"></button>
                        <button onclick="setTheme('dark')" class="theme-option w-10 h-10 rounded-full bg-gradient-to-br from-[#1C1C1E] to-[#2C2C2E] border-2 border-white shadow-md" title="Dark"></button>
                        <button onclick="setTheme('rose')" class="theme-option w-10 h-10 rounded-full bg-gradient-to-br from-[#FFF0F3] to-[#FFCDD2] border-2 border-white shadow-md" title="Rose"></button>
                        <button onclick="setTheme('ocean')" class="theme-option w-10 h-10 rounded-full bg-gradient-to-br from-[#E8F4F8] to-[#B3E5FC] border-2 border-white shadow-md" title="Ocean"></button>
                        <button onclick="setTheme('lavender')" class="theme-option w-10 h-10 rounded-full bg-gradient-to-br from-[#F3E8FF] to-[#E1BEE7] border-2 border-white shadow-md" title="Lavender"></button>
                        <button onclick="setTheme('mint')" class="theme-option w-10 h-10 rounded-full bg-gradient-to-br from-[#E8F5E9] to-[#A5D6A7] border-2 border-white shadow-md" title="Mint"></button>
                    </div>
                    <p class="text-xs text-ios-secondary themed-text-secondary">Choose your couple theme üíï</p>
                </div>

                <!-- Quick Actions -->
                <div class="bg-ios-bg rounded-2xl overflow-hidden themed-bg">
                    <h3 class="text-sm font-semibold text-ios-text px-4 pt-4 pb-2 themed-text">
                        <i class="fas fa-bolt mr-2 text-yellow-500"></i>Quick Actions
                    </h3>
                    
                    <button onclick="window.location.href='gallery.html?folder=all'" class="w-full flex items-center justify-between px-4 py-3 border-b border-ios-separator/20 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-pink-500 flex items-center justify-center">
                                <i class="fas fa-images text-white text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Our Gallery</span>
                        </div>
                        <i class="fas fa-chevron-right text-ios-separator text-xs"></i>
                    </button>
                    
                    <button onclick="window.location.href='goals.html'" class="w-full flex items-center justify-between px-4 py-3 border-b border-ios-separator/20 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center">
                                <i class="fas fa-bullseye text-white text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Couple Goals</span>
                        </div>
                        <i class="fas fa-chevron-right text-ios-separator text-xs"></i>
                    </button>
                    
                    <button onclick="window.location.href='resolutions.html'" class="w-full flex items-center justify-between px-4 py-3 border-b border-ios-separator/20 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-purple-500 flex items-center justify-center">
                                <i class="fas fa-list-check text-white text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Resolutions</span>
                        </div>
                        <i class="fas fa-chevron-right text-ios-separator text-xs"></i>
                    </button>
                    
                    <button onclick="window.location.href='stats.html'" class="w-full flex items-center justify-between px-4 py-3 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center">
                                <i class="fas fa-chart-line text-white text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Love Stats</span>
                        </div>
                        <i class="fas fa-chevron-right text-ios-separator text-xs"></i>
                    </button>
                </div>

                <!-- Preferences -->
                <div class="bg-ios-bg rounded-2xl overflow-hidden themed-bg">
                    <h3 class="text-sm font-semibold text-ios-text px-4 pt-4 pb-2 themed-text">
                        <i class="fas fa-sliders mr-2 text-ios-blue themed-accent"></i>Preferences
                    </h3>
                    
                    <div class="flex items-center justify-between px-4 py-3 border-b border-ios-separator/20">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-ios-secondary/20 flex items-center justify-center">
                                <i class="fas fa-bell text-ios-secondary text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Notifications</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notificationsToggle" checked onchange="savePreferences()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between px-4 py-3 border-b border-ios-separator/20">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-ios-secondary/20 flex items-center justify-center">
                                <i class="fas fa-volume-high text-ios-secondary text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Sound Effects</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundToggle" checked onchange="savePreferences()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between px-4 py-3 border-b border-ios-separator/20">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-ios-secondary/20 flex items-center justify-center">
                                <i class="fas fa-heart-pulse text-ios-secondary text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Love Reminders</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="remindersToggle" onchange="savePreferences()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-ios-secondary/20 flex items-center justify-center">
                                <i class="fas fa-eye text-ios-secondary text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Read Receipts</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="readReceiptsToggle" checked onchange="savePreferences()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Fun Features -->
                <div class="bg-ios-bg rounded-2xl overflow-hidden themed-bg">
                    <h3 class="text-sm font-semibold text-ios-text px-4 pt-4 pb-2 themed-text">
                        <i class="fas fa-sparkles mr-2 text-yellow-400"></i>Fun Features
                    </h3>
                    
                    <button onclick="sendLoveNudge()" class="w-full flex items-center justify-between px-4 py-3 border-b border-ios-separator/20 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-red-400 flex items-center justify-center">
                                <i class="fas fa-heart text-white text-sm"></i>
                            </div>
                            <div class="text-left">
                                <span class="text-sm text-ios-text block themed-text">Send Love Nudge</span>
                                <span class="text-[10px] text-ios-secondary themed-text-secondary">Let them know you're thinking of them</span>
                            </div>
                        </div>
                        <i class="fas fa-paper-plane text-ios-blue themed-accent"></i>
                    </button>
                    
                    <button onclick="showRandomMemory()" class="w-full flex items-center justify-between px-4 py-3 border-b border-ios-separator/20 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-amber-400 flex items-center justify-center">
                                <i class="fas fa-shuffle text-white text-sm"></i>
                            </div>
                            <div class="text-left">
                                <span class="text-sm text-ios-text block themed-text">Random Memory</span>
                                <span class="text-[10px] text-ios-secondary themed-text-secondary">Relive a beautiful moment</span>
                            </div>
                        </div>
                        <i class="fas fa-dice text-ios-blue themed-accent"></i>
                    </button>
                    
                    <button onclick="showDailyQuestion()" class="w-full flex items-center justify-between px-4 py-3 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center">
                                <i class="fas fa-question text-white text-sm"></i>
                            </div>
                            <div class="text-left">
                                <span class="text-sm text-ios-text block themed-text">Daily Question</span>
                                <span class="text-[10px] text-ios-secondary themed-text-secondary">Get to know each other better</span>
                            </div>
                        </div>
                        <i class="fas fa-lightbulb text-yellow-400"></i>
                    </button>
                </div>

                <!-- Account -->
                <div class="bg-ios-bg rounded-2xl overflow-hidden themed-bg">
                    <h3 class="text-sm font-semibold text-ios-text px-4 pt-4 pb-2 themed-text">
                        <i class="fas fa-user-gear mr-2 text-ios-blue themed-accent"></i>Account
                    </h3>
                    
                    <button onclick="window.location.href='profile.html'" class="w-full flex items-center justify-between px-4 py-3 border-b border-ios-separator/20 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-ios-blue flex items-center justify-center">
                                <i class="fas fa-user-edit text-white text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Edit Profile</span>
                        </div>
                        <i class="fas fa-chevron-right text-ios-separator text-xs"></i>
                    </button>
                    
                    <button onclick="exportData()" class="w-full flex items-center justify-between px-4 py-3 border-b border-ios-separator/20 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-green-500 flex items-center justify-center">
                                <i class="fas fa-download text-white text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-text themed-text">Export Data</span>
                        </div>
                        <i class="fas fa-chevron-right text-ios-separator text-xs"></i>
                    </button>
                    
                    <button onclick="confirmLogout()" class="w-full flex items-center justify-between px-4 py-3 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-ios-red flex items-center justify-center">
                                <i class="fas fa-sign-out-alt text-white text-sm"></i>
                            </div>
                            <span class="text-sm text-ios-red">Logout</span>
                        </div>
                        <i class="fas fa-chevron-right text-ios-separator text-xs"></i>
                    </button>
                </div>

                <!-- Security & Encryption -->
                <div class="bg-ios-bg rounded-2xl overflow-hidden themed-bg">
                    <h3 class="text-sm font-semibold text-ios-text px-4 pt-4 pb-2 themed-text">
                        <i class="fas fa-shield-halved mr-2 text-ios-green"></i>Security
                    </h3>
                    
                    <div class="px-4 py-3 border-b border-ios-separator/20">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-ios-green flex items-center justify-center">
                                <i class="fas fa-lock text-white text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <span class="text-sm text-ios-text block themed-text">End-to-End Encryption</span>
                                <span class="text-[10px] text-ios-green">Active ‚úì</span>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="showEncryptionInfo()" class="w-full flex items-center justify-between px-4 py-3 hover:bg-ios-separator/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center">
                                <i class="fas fa-circle-info text-white text-sm"></i>
                            </div>
                            <div class="text-left">
                                <span class="text-sm text-ios-text block themed-text">Learn More</span>
                                <span class="text-[10px] text-ios-secondary themed-text-secondary">How your data is protected</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-ios-separator text-xs"></i>
                    </button>
                </div>

                <!-- App Info -->
                <div class="text-center py-4">
                    <p class="text-xs text-ios-secondary themed-text-secondary">LoveLoggy v1.0</p>
                    <p class="text-[10px] text-ios-secondary/60 themed-text-secondary">Made with ‚ù§Ô∏è for couples</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-ios-text text-white px-4 py-2 rounded-full text-sm shadow-lg opacity-0 transition-opacity duration-300 z-[100]">
        <span id="toastMessage">Message sent!</span>
    </div>

    <script>
        // Check login via auth module
        const user = window.LoveLoggyAuth && LoveLoggyAuth.getCurrentUser ? LoveLoggyAuth.getCurrentUser() : JSON.parse(localStorage.getItem('loveloggy_user') || 'null');
        if (!user) {
            window.location.href = 'index.html';
        }

        // Settings Panel Functions
        function openSettings() {
            document.getElementById('settingsOverlay').classList.add('open');
            document.getElementById('settingsPanel').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeSettings() {
            document.getElementById('settingsOverlay').classList.remove('open');
            document.getElementById('settingsPanel').classList.remove('open');
            document.body.style.overflow = '';
        }

        // Theme Functions
        function setTheme(themeName) {
            const body = document.body;
            // Remove all theme classes
            body.classList.remove('themed', 'dark-theme', 'rose-theme', 'ocean-theme', 'lavender-theme', 'mint-theme');
            
            // Remove selected from all theme options
            document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('selected'));
            
            if (themeName !== 'default') {
                body.classList.add('themed', `${themeName}-theme`);
            }
            
            // Add selected to current theme
            event.target.classList.add('selected');
            
            // Save preference
            localStorage.setItem('loveloggy_theme', themeName);
            showToast(`Theme changed to ${themeName === 'default' ? 'Sand' : themeName.charAt(0).toUpperCase() + themeName.slice(1)}! ‚ú®`);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('loveloggy_theme') || 'default';
            const body = document.body;
            
            if (savedTheme !== 'default') {
                body.classList.add('themed', `${savedTheme}-theme`);
            }
            
            // Mark selected theme
            const themeButtons = document.querySelectorAll('.theme-option');
            const themeNames = ['default', 'dark', 'rose', 'ocean', 'lavender', 'mint'];
            themeNames.forEach((name, index) => {
                if (name === savedTheme && themeButtons[index]) {
                    themeButtons[index].classList.add('selected');
                }
            });
        }

        // Preferences
        function savePreferences() {
            const prefs = {
                notifications: document.getElementById('notificationsToggle').checked,
                sound: document.getElementById('soundToggle').checked,
                reminders: document.getElementById('remindersToggle').checked,
                readReceipts: document.getElementById('readReceiptsToggle').checked
            };
            localStorage.setItem('loveloggy_prefs', JSON.stringify(prefs));
            showToast('Preferences saved! ‚úì');
        }

        function loadPreferences() {
            const prefs = JSON.parse(localStorage.getItem('loveloggy_prefs') || '{}');
            if (prefs.notifications !== undefined) document.getElementById('notificationsToggle').checked = prefs.notifications;
            if (prefs.sound !== undefined) document.getElementById('soundToggle').checked = prefs.sound;
            if (prefs.reminders !== undefined) document.getElementById('remindersToggle').checked = prefs.reminders;
            if (prefs.readReceipts !== undefined) document.getElementById('readReceiptsToggle').checked = prefs.readReceipts;
        }

        // Toast Notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2500);
        }

        // Fun Features
        const loveNudges = [
            "üíï Someone is thinking about you right now!",
            "‚ù§Ô∏è You just got a virtual hug!",
            "üíñ Your partner sends you a kiss!",
            "ü•∞ Someone loves you very much!",
            "‚ú® You're the best thing that happened to them!",
            "üíó Sending you all my love!",
            "üòò *virtual smooch*",
            "üåπ You're as beautiful as this rose!"
        ];

        function sendLoveNudge() {
            const nudge = loveNudges[Math.floor(Math.random() * loveNudges.length)];
            showToast(nudge);
            closeSettings();
        }

        function showRandomMemory() {
            const messages = JSON.parse(localStorage.getItem('loveloggy_chat') || '[]');
            if (messages.length === 0) {
                showToast("No memories yet! Start chatting üí¨");
            } else {
                const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                showToast(`Memory: "${randomMsg.text.substring(0, 50)}${randomMsg.text.length > 50 ? '...' : ''}" üìù`);
            }
            closeSettings();
        }

        const dailyQuestions = [
            "What's one thing you love most about your partner?",
            "Describe your perfect date night together.",
            "What's a dream you'd like to achieve together?",
            "What song reminds you of your relationship?",
            "What's your favorite memory together?",
            "What makes your partner laugh the most?",
            "If you could travel anywhere together, where would it be?",
            "What's something new you'd like to try together?",
            "What's the most thoughtful thing your partner has done?",
            "What do you admire most about your partner?"
        ];

        function showDailyQuestion() {
            const question = dailyQuestions[Math.floor(Math.random() * dailyQuestions.length)];
            showToast(`üí≠ ${question}`);
            closeSettings();
        }

        function showEncryptionInfo() {
            alert(`üîê End-to-End Encryption

Your messages are protected with end-to-end encryption.

How it works:
‚Ä¢ Messages are encrypted before being saved
‚Ä¢ Only you and your partner can read them
‚Ä¢ A unique key is generated from your profile data
‚Ä¢ Even if someone accesses your device, they can't read your messages without your credentials

Your privacy is our priority! üíï`);
            closeSettings();
        }

        function exportData() {
            const data = {
                user: localStorage.getItem('loveloggy_user'),
                chat: localStorage.getItem('loveloggy_chat'),
                events: localStorage.getItem('loveloggy_events'),
                goals: localStorage.getItem('loveloggy_goals'),
                preferences: localStorage.getItem('loveloggy_prefs'),
                theme: localStorage.getItem('loveloggy_theme')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'loveloggy_backup.json';
            a.click();
            showToast('Data exported! üì•');
            closeSettings();
        }

        function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                if (window.LoveLoggyAuth && LoveLoggyAuth.logout) {
                    LoveLoggyAuth.logout();
                } else {
                    localStorage.removeItem('loveloggy_user');
                }
                window.location.href = 'index.html';
            }
        }

        // --- E2E: server-backed key registration + AES-GCM encryption flow ---
        const API_BASE = localStorage.getItem('loveloggy_api_base') || 'http://localhost:3000/api';

        async function importPrivateJwk(jwk) {
            return crypto.subtle.importKey('jwk', jwk, { name: 'ECDH', namedCurve: 'P-256' }, true, ['deriveKey']);
        }

        // Ensure an ECDH keypair exists locally and register the public JWK to the server
        async function ensureKeyPairAndRegister() {
            const couple = JSON.parse(localStorage.getItem('loveloggy_couple') || 'null');
            if (!couple) return null;

            let privateJwk = localStorage.getItem('loveloggy_ecdh_private');
            let publicJwk = localStorage.getItem('loveloggy_ecdh_public');
            let privateKeyCrypto = null;

            if (privateJwk && publicJwk) {
                privateJwk = JSON.parse(privateJwk);
                publicJwk = JSON.parse(publicJwk);
                try {
                    privateKeyCrypto = await importPrivateJwk(privateJwk);
                } catch (e) {
                    console.warn('Failed to import stored private JWK, regenerating', e);
                    privateJwk = publicJwk = null;
                }
            }

            if (!privateJwk || !publicJwk) {
                // generate and persist
                const kp = await LoveLoggyEncryption.generateKeyPair();
                publicJwk = await LoveLoggyEncryption.exportPublicKeyJwk(kp.publicKey);
                privateJwk = await crypto.subtle.exportKey('jwk', kp.privateKey);
                // store
                localStorage.setItem('loveloggy_ecdh_private', JSON.stringify(privateJwk));
                localStorage.setItem('loveloggy_ecdh_public', JSON.stringify(publicJwk));
                privateKeyCrypto = kp.privateKey;
            }

            // Register public JWK to server (best-effort) - no coupleId needed in 1-to-1 system
            try {
                await fetch(`${API_BASE}/keys/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, publicKeyJwk: publicJwk })
                });
            } catch (e) {
                // Server might be down ‚Äî that's OK, we keep keys locally and continue with local fallback
                console.warn('Could not register public key with server:', e);
            }

            return { privateKeyCrypto, publicJwk };
        }

        // Fetch partner public JWK from server (no coupleId needed)
        async function fetchPartnerPublicJwk() {
            const couple = JSON.parse(localStorage.getItem('loveloggy_couple') || 'null');
            if (!couple) return null;

            try {
                const res = await fetch(`${API_BASE}/keys/partner/${user.id}`);
                if (!res.ok) return null;
                const body = await res.json();
                return body.publicKeyJwk || null;
            } catch (e) {
                console.warn('Failed to fetch partner public JWK:', e);
                return null;
            }
        }

        async function deriveAesKey() {
            // Ensure we have keys
            const kp = await ensureKeyPairAndRegister();
            if (!kp || !kp.privateKeyCrypto) return null;

            // get partner pub
            const partnerJwk = await fetchPartnerPublicJwk();
            if (!partnerJwk) return null;

            try {
                const aesKey = await LoveLoggyEncryption.deriveAesKeyFromPrivate(kp.privateKeyCrypto, partnerJwk);
                return aesKey;
            } catch (e) {
                console.error('Failed to derive AES key:', e);
                return null;
            }
        }

        // Fetch messages from server and decrypt; if server unavailable, fallback to localStorage
        async function loadMessages() {
            const couple = JSON.parse(localStorage.getItem('loveloggy_couple') || 'null');
            if (!couple) return [];

            // Try server first (no coupleId needed in 1-to-1 system)
            try {
                const res = await fetch(`${API_BASE}/messages`);
                if (!res.ok) throw new Error('Server returned ' + res.status);
                const body = await res.json();
                const messages = body.messages || body;

                const aesKey = await deriveAesKey();
                if (!aesKey) {
                    console.warn('No AES key derived; messages will not be decrypted');
                    return messages.map(m => ({ ...m, text: '[Encrypted message]' }));
                }

                const out = [];
                for (const m of messages) {
                    try {
                        const decrypted = await LoveLoggyEncryption.decryptMessageObject(aesKey, m.ciphertext, m.iv);
                        out.push({ id: m.id || m._id || Date.now(), sender: m.senderName || m.sender, senderId: m.senderId, text: (typeof decrypted === 'string' ? decrypted : decrypted.text || JSON.stringify(decrypted)), timestamp: m.timestamp || m.createdAt });
                    } catch (e) {
                        console.warn('Failed to decrypt message', e);
                        out.push({ id: m.id || Date.now(), sender: m.senderName || m.sender, senderId: m.senderId, text: '[Encrypted message]', timestamp: m.timestamp || m.createdAt });
                    }
                }
                // also save a local copy for quick access
                localStorage.setItem('loveloggy_chat', JSON.stringify(out));
                return out;
            } catch (e) {
                // Fallback to localStorage
                console.warn('Server unreachable for messages, falling back to localStorage:', e);
                return JSON.parse(localStorage.getItem('loveloggy_chat') || '[]');
            }
        }

        // Send a message: encrypt with derived AES key and POST to server, fallback to localStorage
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            const couple = JSON.parse(localStorage.getItem('loveloggy_couple') || 'null');

            // Try server path (no coupleId needed in 1-to-1 system)
            try {
                const aesKey = await deriveAesKey();
                if (!aesKey) throw new Error('No AES key');

                const payload = { text, ts: new Date().toISOString(), sender: user.name };
                const { iv, ciphertext } = await LoveLoggyEncryption.encryptMessageObject(aesKey, payload);

                const res = await fetch(`${API_BASE}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ senderId: user.id, senderName: user.name, ciphertext, iv, timestamp: payload.ts })
                });

                if (!res.ok) throw new Error('Server returned ' + res.status);

                // refresh messages from server
                const messages = await loadMessages();
                document.getElementById('messageInput').value = '';
                render();
                showToast('Message sent!');
                return;
            } catch (e) {
                // fallback to localStorage
                console.warn('Server send failed, saving locally:', e);
                const messages = JSON.parse(localStorage.getItem('loveloggy_chat') || '[]');
                messages.push({ id: Date.now(), sender: user.name || 'You', senderId: user.id || 'user', text: text, timestamp: new Date().toISOString() });
                localStorage.setItem('loveloggy_chat', JSON.stringify(messages));
                document.getElementById('messageInput').value = '';
                render();
                showToast('Message saved locally');
                return;
            }
        }

        function formatTime(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (d.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (d.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function render() {
            const messages = loadMessages();
            const area = document.getElementById('messagesArea');
            const empty = document.getElementById('emptyState');

            if (messages.length === 0) {
                area.classList.add('hidden');
                empty.classList.remove('hidden');
                empty.classList.add('flex');
                return;
            }

            area.classList.remove('hidden');
            empty.classList.add('hidden');
            empty.classList.remove('flex');

            // Get couple data for determining message ownership
            const couple = JSON.parse(localStorage.getItem('loveloggy_couple') || 'null');

            // Group messages by date
            const grouped = {};
            messages.forEach(m => {
                const dateKey = new Date(m.timestamp).toDateString();
                if (!grouped[dateKey]) grouped[dateKey] = [];
                grouped[dateKey].push(m);
            });

            let html = '';
            Object.keys(grouped).forEach(dateKey => {
                html += `<div class="text-center my-4">
                    <span class="text-[10px] bg-sand-100 text-sand-400 px-3 py-1 rounded-full">${formatDate(grouped[dateKey][0].timestamp)}</span>
                </div>`;

                grouped[dateKey].forEach(m => {
                    // Determine if message is from current user
                    const isMe = (m.senderId && m.senderId === user.id) || m.sender === user.name;
                    
                    // Get avatar for partner messages
                    let partnerAvatar = '';
                    if (couple && couple.user1 && couple.user2) {
                        const partner = user.id === couple.user1.id ? couple.user2 : couple.user1;
                        partnerAvatar = partner.profilePic || '';
                    } else {
                        partnerAvatar = user.partnerPhoto || '';
                    }
                    
                    if (isMe) {
                        html += `
                            <div class="flex justify-end items-end gap-2">
                                <div class="max-w-[75%]">
                                    <div class="bg-clay text-white rounded-2xl rounded-br-sm px-4 py-2">
                                        <p class="text-sm">${escapeHtml(m.text)}</p>
                                    </div>
                                    <p class="text-[10px] text-sand-400 text-right mt-1">${formatTime(m.timestamp)}</p>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="flex justify-start items-end gap-2">
                                <div class="w-8 h-8 rounded-full overflow-hidden bg-sand-200 flex-shrink-0">
                                    ${partnerAvatar ? `<img src="${partnerAvatar}" class="w-full h-full object-cover">` : '<i class="fas fa-user text-sand-400 text-xs flex items-center justify-center h-full"></i>'}
                                </div>
                                <div class="max-w-[75%]">
                                    <p class="text-[10px] text-sand-400 mb-1">${escapeHtml(m.sender)}</p>
                                    <div class="bg-sand-100 text-sand-600 rounded-2xl rounded-bl-sm px-4 py-2">
                                        <p class="text-sm">${escapeHtml(m.text)}</p>
                                    </div>
                                    <p class="text-[10px] text-sand-400 mt-1">${formatTime(m.timestamp)}</p>
                                </div>
                            </div>
                        `;
                    }
                });
            });

            area.innerHTML = html;
            area.scrollTop = area.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            // Get current user - in production, each user logs in as themselves
            const messages = loadMessages();
            messages.push({
                id: Date.now(),
                sender: user.name || 'You',
                senderId: user.id || 'user',
                text: text,
                timestamp: new Date().toISOString()
            });
            saveMessages(messages);

            input.value = '';
            render();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load theme and preferences
            loadTheme();
            loadPreferences();
            
            // Migrate existing unencrypted messages
            migrateExistingMessages();
            
            // Set up header with couple names
            const chatTitle = document.getElementById('chatTitle');
            const couple = JSON.parse(localStorage.getItem('loveloggy_couple') || 'null');
            
            if (couple && couple.user1 && couple.user2) {
                chatTitle.textContent = `${couple.user1.name} & ${couple.user2.name}`;
            } else {
                chatTitle.textContent = `${user.name || 'You'} & ${user.partnerName || 'Partner'}`;
            }

            // Set up avatars
            const avatarA = document.getElementById('avatarA');
            const avatarB = document.getElementById('avatarB');
            
            if (couple && couple.user1 && couple.user1.profilePic) {
                avatarA.innerHTML = `<img src="${couple.user1.profilePic}" class="w-full h-full object-cover">`;
            } else if (user.profilePic) {
                avatarA.innerHTML = `<img src="${user.profilePic}" class="w-full h-full object-cover">`;
            }
            
            if (couple && couple.user2 && couple.user2.profilePic) {
                avatarB.innerHTML = `<img src="${couple.user2.profilePic}" class="w-full h-full object-cover">`;
            } else if (user.partnerPhoto) {
                avatarB.innerHTML = `<img src="${user.partnerPhoto}" class="w-full h-full object-cover">`;
            }

            // Wire up send
            document.getElementById('sendBtn').onclick = sendMessage;
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });

            render();
        });
    </script>
</body>
</html>